@using CUSrinagar.Models
@using CUSrinagar.Extensions
@model CUSrinagar.Models.S2SSearch
@{
    ViewBag.Title = "BillDesk Payment Status ";
}

<div class="page-wrapper pager-table-text">
    <div class="page-header">
        <div style="padding-bottom: 30px;">
            <div class="col-sm-12">
                <div class="col-sm-6">
                    <h1 class="heading-title pull-left">
                        BillDesk
                        <small>
                            <i class="ace-icon fa fa-angle-double-right"></i>
                            Payment Status
                        </small>
                    </h1>
                </div>
                <div class="col-sm-6"></div>
            </div>
        </div>
    </div>
    <div class="page-content">
        <div class="row page-row">
            <div class="content-wrapper col-md-10 col-sm-8 jsSingleContent"></div>
            <div class="col-md-12 jsTableContent">
                <div class="panel panel-primary js-pager-table">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            &nbsp;Search Payment
                        </h3>
                    </div>
                    <div class="panel-body">
                        @using (Html.BeginForm("SearchPayments", "BillDesk", FormMethod.Post, new { area = "CUSrinagarAdminPanel", id = "PaymentStatus" }))
                        {
                            @Html.AntiForgeryToken()
                            <div class="col-sm-12 search-box">
                                <div class="col-sm-2 lbl no-padding-right">
                                    @Html.LabelFor(m => m.FeeType)
                                    <span class="required">
                                        *
                                        @Html.ValidationMessageFor(m => m.FeeType)
                                    </span>
                                    <div id="Course">
                                        @Html.DropDownListFor(m => m.FeeType, (IEnumerable<SelectListItem>)ViewBag.FeeType, string.Empty, new { @class = "form-control" })
                                    </div>
                                </div>
                                <div class="col-sm-2 lbl no-padding-right">
                                    @Html.LabelFor(m => m.Course)
                                    <span class="required">
                                        *
                                        @Html.ValidationMessageFor(m => m.Course)
                                    </span>
                                    <div id="Course">
                                        @Html.DropDownListFor(m => m.Course, (IEnumerable<SelectListItem>)ViewBag.course, string.Empty, new { @class = "form-control" })
                                    </div>
                                </div>
                                <div class="col-sm-3 lbl no-padding-right">
                                    @Html.LabelFor(m => m.SearchQuery)
                                    <span class="required">
                                        *
                                        @Html.ValidationMessageFor(m => m.SearchQuery)
                                    </span>
                                    @Html.TextBoxFor(m => m.SearchQuery, new { @class = " form-control", maxlength = "200", title = "Please use |(pipe) at the end of search query for more accurate results" })
                                </div>
                                <div class="col-sm-1 lbl no-padding-right">
                                    @Html.LabelFor(m => m.Batch)
                                    <span class="required">
                                        @Html.ValidationMessageFor(m => m.Batch)
                                    </span>
                                    @Html.TextBoxFor(m => m.Batch, new { @class = " form-control", maxlength = "4" })
                                </div>
                                <div class="col-sm-1 lbl no-padding-right">
                                    @Html.LabelFor(m => m.TxnDate)
                                    <span class="required">
                                        @Html.ValidationMessageFor(m => m.TxnDate)
                                    </span>
                                    @Html.TextBoxFor(m => m.TxnDate, new { @class = " form-control", maxlength = "10", placeholder = "dd-mm-yyyy" })
                                </div>
                                <div class="col-sm-1 " style="padding-top: 17px;">
                                    <button type="submit" class="btn btn-primary" id="JSSearchPay"><i class="fa fa-search"></i>&nbsp; Search Payments</button>
                                </div>
                            </div>
                        }
                    </div>
                    @*------------- search result ------------*@
                    <br />
                    <input type="hidden" id="FeeTypeSelected" value="@ViewBag.FeeTypeSelected" />
                    <div>
                        @{ List<BillDeskStoredRequest> billDeskStoredRequests = (List<BillDeskStoredRequest>)ViewBag.StoredRequests;}
                        <table class="table-bordered table">
                            <thead>
                                <tr>
                                    <th>Dated</th>
                                    <th>MerchantID</th>
                                    <th>CustomerID</th>
                                    <th>Amount</th>
                                    <th>Mobile</th>
                                    <th>Email</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody class="DelOnChange">
                                @if (billDeskStoredRequests.IsNotNullOrEmpty())
                                {
                                    string[] email = null;
                                    foreach (var item in billDeskStoredRequests)
                                    {
                                        email = System.Text.RegularExpressions.Regex.Split(item.RequestArray[15], @"__") ?? null;
                                        <tr>
                                            <td>@item.CreatedOn.ToString("dd MMMM,yyyy hh:mm tt")</td>
                                            <td>@item.RequestArray[0]</td>
                                            <td>@item.RequestArray[1]</td>
                                            <td><i class="fa fa-rupee"></i> @item.RequestArray[3]</td>
                                            <td>@item.RequestArray[14]</td>
                                            @if (email?.Length > 1)
                                            {
                                                <td>@email[1]</td>
                                            }
                                            else
                                            {
                                                <td>@item.RequestArray[15]</td>
                                            }
                                            <th class="ChkStatus" data-CustomerID="@item.RequestArray[1]"><button type="button" class="btn-success">Check Status</button></th>
                                        </tr>
                                        <tr class="@item.RequestArray[1] hidden">
                                            <td colspan="7">
                                                <table class="table-bordered alert-info" style="width:100%">
                                                    <tr>
                                                        <th style="width:20%">BillDesk Status</th>
                                                        <th>University Status</th>
                                                        <th>TxnReferenceNo</th>
                                                        <th>TxnAmount(INR)</th>
                                                        <th>TxnDated</th>
                                                        <th>Additional Info</th>
                                                        <th></th>
                                                    </tr>
                                                    <tr id="@item.RequestArray[1]"></tr>
                                                </table>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <th colspan="7" class="text-center">No results found, Please check your search parameters.</th>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section PageSpecificJS{
    @Scripts.Render("~/bundles/Libraries/jqueryval");
    <script src="@Url.Content("~/Content/ThemeAdmin/Content/Scripts/JSBillDesk/JSCUSPaymentStatus.js")"></script>
}

@section PageSpecificStyle{
    <style>
        .filter-btn a {
            color: white !important
        }

        .required {
            color: red !important;
        }
    </style>
}


